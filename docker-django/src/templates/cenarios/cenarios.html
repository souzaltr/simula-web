{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cenários • SimulaWEB</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--b:#0e5f9e;--c:#1b76bd;--bg:#f3f6fb;--card:#fff;--muted:#6b7280;--danger:#ef4444;--shadow:0 10px 20px rgba(12,76,128,.08);--r:14px}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui;color:#0f172a}

/* GLOBAL MESSAGES (topo, largura total) */
.global-messages{max-width:1100px;margin:14px auto 0;padding:0 20px}
.global-messages .msg{margin:0 0 6px;padding:8px 10px;border-radius:8px;background:#ecfeff;color:#075985}
.global-messages .msg.error{background:#fee2e2;color:#b91c1c}

/* GRID 3 colunas: Insumos | Produtos | Cenários */
.container{max-width:1100px;margin:14px auto;padding:0 20px;display:grid;gap:20px;grid-template-columns:1fr 1fr 1fr}
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;min-height:140px}

h1,h2{margin:0 0 10px}
h1{font-size:18px}

.list{display:flex;flex-direction:column;gap:8px;max-height:50vh;overflow:auto;margin:10px 0}
.item{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
.item small{color:#64748b}

.badge{display:inline-block;background:#ecfeff;color:#075985;padding:8px 10px;border-radius:10px;margin-bottom:10px}
.badge-pill{display:inline-block;background:#eef6ff;color:#0b5ea8;padding:6px 10px;border-radius:999px;font-size:12px}
.code-chip{background:#f1f5f9;border-radius:999px;padding:4px 8px;font-size:12px;color:#475569}

.row{display:grid;gap:10px}
label{display:block;font-size:14px;color:#111827;margin-bottom:4px}
input[type="text"], select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}

.btn{display:inline-block;background:var(--b);color:#fff !important;text-decoration:none;padding:10px 10px;border-radius:10px;font-weight:700;border:none;cursor:pointer}
.btn.alt{background:#0ea5e9}
.btn.danger{background:var(--danger)}
.btn{
  margin-bottom:6px;
}
.actions a{display:inline-block;background:var(--b);color:#fff !important;text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:700}
.actions a.alt{background:#0ea5e9}
.actions a.danger{background:var(--danger)}


/* Erros de campo (se usados) */
.errors-card{background-color:#fee2e2;border-left:3px solid #ef4444;border-radius:8px;padding:6px 8px;margin:10px 0;color:#b91c1c;font-weight:300;box-shadow:0 0px 4px rgba(0,0,0,0.06)}

/* Responsivo */
@media(max-width:980px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>

{% include '_partials/navbar.html' %}

<!-- MENSAGENS GLOBAIS (fora das colunas) -->
{% if messages %}
  <div class="global-messages">
    {% for message in messages %}
      <p class="msg{% if message.tags %} {{ message.tags }}{% endif %}">{{ message }}</p>
    {% endfor %}
  </div>
{% endif %}

<!-- GRADE 3 COLUNAS -->
<div class="container">
  <!-- ESQUERDA — INSUMOS -->
  <section class="card">

      <!-- FILTRO DE INSUMOS -->
    <div class="toolbar">
      <form class="search" method="get">
        <span aria-hidden="true">🔎</span>
        <input type="text" name="q_insumo" value="{{ q_insumo|default:'' }}" placeholder="Busque um insumo pelo nome ou forncedor.">
        <input type="hidden" name="sort_insumo" value="{{ sort_insumo|default:'asc' }}">
        <button class="btn alt" type="submit">Filtrar</button>
      </form>
    </div>

  
    <div class="list-head">
      <a class ="btn alt" href="?{% if q_insumo %}q_insumo={{ q_insumo|urlencode }}&{% endif %}sort_insumo={% if sort_insumo == 'asc' %}desc{% else %}asc{% endif %}"
         title="Ordenar por nome">
        Ordenar Nomes
        <span>{% if sort_insumo == 'asc' %}▲{% else %}▼{% endif %}</span>
      </a>
    </div>

    <h1>Lista Insumos</h1>

    <div class="list">
      {% for insumo in insumos %}
        <div class="item">
          <div style="flex:1">
            <div style="font-weight:700">{{ insumo.nome }}</div>
            <small>Fornecedor: <span class="code-chip">{{ insumo.fornecedor }}</span></small>
          </div>
          <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
            <a href="{% url 'cenarios:editarInsumo' insumo.id %}" class="alt">Editar</a>
            <a href="{% url 'cenarios:removerInsumo' insumo.id %}" class="danger"
               onclick="return confirm('Voce tem certeza que deseja excluir o insumo {{insumo.nome}}?\nAtenção só é possível apagar um insumo que não está vinculado a um produto.');">Excluir</a>
          </div>
        </div>
      {% empty %}
        <div class="item"><small>Nenhum insumo cadastrado.</small></div>
      {% endfor %}
    </div>

    <form action="" method="post" class="row">
      {% csrf_token %}
      {{ insumo_form }}
      <input type="hidden" name="model_type" value="insumo">
      <button type="submit" class="btn" name="action" value="create">Salvar Insumo</button>
    </form>
  </section>

  <!-- CENTRO — PRODUTOS -->
  <section class="card">

        <div class="toolbar">
      <form class="search" method="get">
        <span aria-hidden="true">🔎</span>
        <input type="text" name="q_produto" value="{{ q_produto|default:'' }}" placeholder="Busque um produto pelo nome ou insumos.">
        <input type="hidden" name="sort_produto" value="{{ sort_produto|default:'asc' }}">
        <button class="btn alt" type="submit">Filtrar</button>
      </form>
    </div>

   
    <div class="list-head">
      <a class="btn alt" href="?{% if q_produto %}q_produto={{ q_produto|urlencode }}&{% endif %}sort_produto={% if sort_produto == 'asc' %}desc{% else %}asc{% endif %}"
         title="Ordenar por nome">
        Ordenar Nomes
        <span>{% if sort_produto == 'asc' %}▲{% else %}▼{% endif %}</span>
      </a>
    </div>

    <h1>Lista Produtos</h1>
    <div class="list">
      {% for produto in produtos %}
        <div class="item">
          <div style="flex:1">
            <div style="font-weight:700">{{ produto.nome }}</div>
            <small>Insumos:
              {% for insumo in produto.insumos.all %}
                <span class="code-chip">{{ insumo.nome }}</span>{% if not forloop.last %} {% endif %}
              {% empty %}
                nenhum
              {% endfor %}
            </small>
          </div>
          <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
            <a href="{% url 'cenarios:editarProduto' produto.id %}" class="alt">Editar</a>
            <a href="{% url 'cenarios:removerProduto' produto.id %}" class="danger"
               onclick="return confirm('Voce tem certeza que deseja excluir o produto {{produto.nome}}?\nAtenção só é possível deletar um produto que não está vinculado a nenhum cenário');">Excluir</a>
          </div>
        </div>
      {% empty %}
        <div class="item"><small>Nenhum produto cadastrado.</small></div>
      {% endfor %}
    </div>

    <form action="" method="post" class="row">
      {% csrf_token %}
      {{ produto_form }}
      <input type="hidden" name="model_type" value="produto">
      <button type="submit" class="btn" name="action" value="create">Salvar Produto</button>
    </form>
  </section>

  <!-- DIREITA — CENÁRIOS -->
  <section class="card">

        <div class="toolbar">
      <form class="search" method="get">
        <span aria-hidden="true">🔎</span>
        <input type="text" name="q_cenario" value="{{ q_cenario|default:'' }}" placeholder="Busque um Cenário pelo nome ou produto.">
        <input type="hidden" name="sort_cenario" value="{{ sort_cenario|default:'asc' }}">
        <button class="btn alt" type="submit">Filtrar</button>
      </form>
    </div>

 
    <div class="list-head">
      <a class="btn alt" href="?{% if q_cenario %}q_cenario={{ q_cenario|urlencode }}&{% endif %}sort_cenario={% if sort_cenario == 'asc' %}desc{% else %}asc{% endif %}"
         title="Ordenar por nome">
        Ordenar Nomes
        <span>{% if sort_cenario == 'asc' %}▲{% else %}▼{% endif %}</span>
      </a>
    </div>

    <h1>Lista Cenários</h1>
    <div class="list">
      {% for cenario in cenarios %}
        <div class="item">
          <div style="flex:1">
            <div style="font-weight:700">{{ cenario.nome }}</div>
            <small>Produto: <span class="code-chip">{{ cenario.produto.nome }}</span></small>
          </div>
          <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
            <a href="{% url 'cenarios:editarCenario' cenario.id %}" class="alt">Editar</a>
            <a href="{% url 'cenarios:removerCenario' cenario.id %}" class="danger"
               onclick="return confirm('Voce tem certeza que deseja excluir o Cenário {{ cenario.nome }}?\nAtenção: Só é possível deletar um Cenário que está num Jogo Inativo!\nOs jogos também serão excluídos!');">Excluir</a>
          </div>
        </div>
      {% empty %}
        <div class="item"><small>Nenhum cenário cadastrado.</small></div>
      {% endfor %}
    </div>

    <form action="" method="post" class="row">
      {% csrf_token %}
      {{ cenario_form }}
      <input type="hidden" name="model_type" value="cenario">
      <button type="submit" class="btn" name="action" value="create">Salvar Cenário</button>
    </form>
  </section>
</div>
<div style="max-width: 800px; margin: 20px auto; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
    <section class="card" style="border-radius: 12px; padding: 20px; background-color: #fff;">
        <h1 style="border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; text-align: center;">
            Itens em Jogos Ativos
        </h1>

        <!-- Insumos Ativos -->
        <div class="list-head" style="display:flex; justify-content: space-between; align-items:center; margin-bottom:10px;">
            <h3>Insumos:</h3>
            <a class="btn alt" href="?sort_insumo={% if sort_insumo == 'asc' %}desc{% else %}asc{% endif %}" title="Ordenar por nome">
                Ordenar Nomes
                <span>{% if sort_insumo == 'asc' %}▲{% else %}▼{% endif %}</span>
            </a>
        </div>
        <div class="list">
            {% for insumo in insumos_ativos %}
                <div class="item">
                    <div style="flex:1">
                        <div style="font-weight:700">{{ insumo.nome }}</div>
                        <small>{% if insumo.fornecedor %}Fornecedor: <span class="code-chip">{{ insumo.fornecedor }}</span>{% endif %}</small>
                    </div>
                </div>
            {% empty %}
                <div class="item"><small>Nenhum insumo encontrado em jogos ativos.</small></div>
            {% endfor %}
        </div>

        <!-- Produtos Ativos -->
        <div class="list-head" style="display:flex; justify-content: space-between; align-items:center; margin-top:20px;">
            <h3>Produtos:</h3>
            <a class="btn alt" href="?sort_produto={% if sort_produto == 'asc' %}desc{% else %}asc{% endif %}" title="Ordenar por nome">
                Ordenar Nomes
                <span>{% if sort_produto == 'asc' %}▲{% else %}▼{% endif %}</span>
            </a>
        </div>
        <div class="list">
            {% for produto in produtos_ativos %}
                <div class="item">
                    <div style="flex:1">
                        <div style="font-weight:700">{{ produto.nome }}</div>
                        <small>Insumos:
                            {% for insumo in produto.insumos.all %}
                                <span class="code-chip">{{ insumo.nome }}</span>{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                nenhum
                            {% endfor %}
                        </small>
                    </div>
                </div>
            {% empty %}
                <div class="item"><small>Nenhum produto encontrado em jogos ativos.</small></div>
            {% endfor %}
        </div>

        <!-- Cenários Ativos -->
        <div class="list-head" style="display:flex; justify-content: space-between; align-items:center; margin-top:20px;">
            <h3>Cenários:</h3>
            <a class="btn alt" href="?sort_cenario={% if sort_cenario == 'asc' %}desc{% else %}asc{% endif %}" title="Ordenar por nome">
                Ordenar Nomes
                <span>{% if sort_cenario == 'asc' %}▲{% else %}▼{% endif %}</span>
            </a>
        </div>
        <div class="list">
            {% for cenario in cenarios_ativos %}
                <div class="item">
                    <div style="flex:1">
                        <div style="font-weight:700">{{ cenario.nome }}</div>
                        <small>Produto: <span class="code-chip">{{ cenario.produto.nome }}</span></small>
                    </div>
                </div>
            {% empty %}
                <div class="item"><small>Nenhum cenário encontrado em jogos ativos.</small></div>
            {% endfor %}
        </div>
    </section>
</div>
</div>
</body>
</html>
